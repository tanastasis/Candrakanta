<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <title>{% block title %}Ārśi-Candrakānta{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:opsz,wght@8..60,400;8..60,600&display=swap" rel="stylesheet" />
</head>

<body x-data="{ sidebarOpen: false }" class="min-h-screen text-slate-100 flex flex-col">

  <!-- ВСЕ СТИЛИ ПЕРЕНЕСЛИ СЮДА — теперь они применяются при любом HTMX-свопе -->
  <style>
    html { font-family: "Source Serif 4", Georgia, serif !important; font-kerning: normal; font-variant-ligatures: common-ligatures; }
    
    body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      background-attachment: fixed;
      position: relative;
      overflow-x: hidden;
    }

    :root { --link-color: #a1aae0; }
    nav a:hover { color: #fbbf24 !important; }
    nav a.active { color: #fbbf24; }
  </style>

  <!-- Кнопка-гамбургер -->
  <button @click="sidebarOpen = !sidebarOpen"
          class="fixed top-4 left-4 z-50 md:hidden p-3 rounded-lg bg-slate-800/90 backdrop-blur hover:bg-slate-700">
    <svg class="w-6 h-6 text-amber-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path x-show="!sidebarOpen" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
      <path x-show="sidebarOpen" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
    </svg>
  </button>

  <!-- Оверлей -->
  <div x-show="sidebarOpen" @click="sidebarOpen = false"
       class="fixed inset-0 bg-black/70 z-40 md:hidden" x-transition.opacity></div>

  <!-- Header — теперь звёздное небо всегда будет -->
  <header class="relative flex items-end w-full border-b overflow-hidden header-sky">
    <div class="w-48 mr-2">
      <img src="/static/logo1.png" alt="Buddhist monk under the Moon" class="w-full h-auto object-contain">
    </div>
    <a href="/" class="font-semibold text-2xl ml-6 mb-[5rem] text-slate-100 hover:text-amber-300">
      Ārśi-Candrakānta
    </a>
    <div class="ml-auto mr-[6rem] flex items-end gap-[3rem]">
      <img src="/static/logo4.png" alt="Hunter" class="h-[8rem] w-auto object-contain">
      <img src="/static/logo3.png" alt="Six-Tusked Elephant" class="h-[9.5rem] w-auto self-end object-contain">
    </div>
  </header>

  <!-- Остальное — как было (сайдбар, main, скрипты) -->
  <div class="flex flex-1 w-full">
    <aside :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full'"
           class="fixed inset-y-0 left-0 w-48 bg-slate-800/50 backdrop-blur-sm border-r p-4 pt-6 z-40
                  transition-transform duration-300 ease-in-out
                  md:translate-x-0 md:static md:z-auto flex-shrink-0">
      <nav class="space-y-1">
        <a href="/" class="block px-3 py-2 rounded hover:bg-slate-700/50 {% if active == 'intro' %}bg-slate-600 text-amber-300 font-semibold active{% endif %}">Introduction</a>
        <a href="/lexemes" class="block px-3 py-2 rounded hover:bg-slate-700/50 {% if active == 'lexemes' %}bg-slate-600 text-amber-300 font-semibold active{% endif %}">Lexemes</a>
        <a href="/morphemes" class="block px-3 py-2 rounded hover:bg-slate-700/50 {% if active == 'morphemes' %}bg-slate-600 text-amber-300 font-semibold active{% endif %}">Morphemes</a>
        <a href="/rules" class="block px-3 py-2 rounded hover:bg-slate-700/50 {% if active == 'rules' %}bg-slate-600 text-amber-300 font-semibold active{% endif %}">Rules</a>
      </nav>
    </aside>

    <main class="flex-1 px-8 py-6 overflow-y-auto bg-slate-900/20">
      {% block content %}{% endblock %}
    </main>
  </div>

  <!-- Скрипты (как раньше) -->
  <script>
    function applyVariantVisibility() { /* ... твой код ... */ }
    document.addEventListener('DOMContentLoaded', applyVariantVisibility);
    document.body.addEventListener('htmx:afterSwap', applyVariantVisibility);
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (window.innerWidth >= 768) {
        document.body.__x.$data.sidebarOpen = true;
      }
    });
  </script>

<!-- ФИКС СТИЛЕЙ ПОСЛЕ HTMX (главное!) -->
<script>
  // Функция, которая возвращает всё в правильный вид
  function applyGlobalStyles() {
    // 1. Градиент + звёзды на body
    document.body.style.background = 'linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%)';
    document.body.style.backgroundAttachment = 'fixed';

    // 2. Звёздочки на body (удаляем старые, если были, и добавляем новые)
    let stars = document.body.querySelector('::before');
    if (!stars) {
      const style = document.createElement('style');
      style.textContent = `
        body::before {
          content: '';
          position: fixed;
          inset: 0;
          z-index: -1;
          background-image: 
            radial-gradient(2px 2px at 20px 30px, #fbbf24, transparent),
            radial-gradient(2px 2px at 40px 70px, #fbbf24, transparent),
            radial-gradient(1px 1px at 90px 40px, #fbbf24, transparent),
            radial-gradient(1px 1px at 130px 80px, #fbbf24, transparent),
            radial-gradient(2px 2px at 160px 30px, #fbbf24, transparent);
          background-repeat: repeat;
          background-size: 200px 200px;
          opacity: 0.1;
          animation: twinkle 4s ease-in-out infinite alternate;
          pointer-events: none;
        }
        @keyframes twinkle { from { opacity: 0.1; } to { opacity: 0.3; } }

        .header-sky::before {
          content: '';
          position: absolute;
          inset: 0;
          z-index: -1;
          background-image: 
            radial-gradient(2px 2px at 10% 20%, #fbbf24, transparent),
            radial-gradient(2px 2px at 30% 60%, #fbbf24, transparent),
            radial-gradient(1px 1px at 50% 30%, #fbbf24, transparent),
            radial-gradient(1px 1px at 70% 80%, #fbbf24, transparent),
            radial-gradient(2px 2px at 90% 40%, #fbbf24, transparent);
          background-repeat: repeat;
          background-size: 200px 200px;
          opacity: 0.5;
          animation: header-twinkle 3s ease-in-out infinite alternate;
        }
        @keyframes header-twinkle { from { opacity: 0.35; } to { opacity: 0.7; } }
      `;
      document.head.appendChild(style);
    }

    // 3. Принудительно перерисовываем header-sky
    document.querySelectorAll('.header-sky').forEach(el => {
      el.classList.remove('header-sky');
      void el.offsetWidth; // магия перерисовки
      el.classList.add('header-sky');
    });
  }

  // При загрузке страницы
  document.addEventListener('DOMContentLoaded', applyGlobalStyles);

  // После КАЖДОГО HTMX-свопа — это самое важное!
  document.body.addEventListener('htmx:afterSwap', applyGlobalStyles);

  // На всякий случай — при ресайзе тоже
  window.addEventListener('resize', applyGlobalStyles);
</script>


</body>
</html>